name: Cloud storefront deployment

on:
  workflow_dispatch:
  push:
    paths:
      - "storefront/**"
    branches:
      - "krasnodar-*"

jobs:
  gitops-publish-storefront:
    runs-on: ubuntu-20.04
    env:
      DOCKER_LOGIN: krasnodar-token
      DOCKER_PASSWORD: ${{ secrets.KRASNODAR_ACR_DOCKER_PASSWORD }}
      CONTAINER_REGISTRY: virtopaasregistrymain.azurecr.io
      IMAGE_REPOSITORY: virtopaasregistrymain.azurecr.io/krasnodar/storefront
      ARGO_APP_NAME: ${{ github.ref_name }}
      VC_BUILD_VERSION: 3.16.0-alpha.148

    steps:
      - uses: actions/checkout@v3

      - name: Install vc-build
        run: |
          dotnet tool install --global VirtoCommerce.GlobalTool --version ${{ env.VC_BUILD_VERSION }}

      - name: Set values
        run: |
          echo "APP_NAME=$(echo ${{ github.ref_name }} | awk -F- '{print $2}')" >> $GITHUB_ENV  

      - name: Get storefront version
        id: platform-version
        run: |
          echo "STOREFRONT_TAG=$(cat ./storefront/image.json | jq -r '.Tag')" >> $GITHUB_ENV
          echo "STOREFRONT_REPO=$(cat ./storefront/image.json | jq -r '.Repository')" >> $GITHUB_ENV

      - name: Docker Login
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.CONTAINER_REGISTRY }}
          username: ${{ env.DOCKER_LOGIN }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Publish platform image to the Virto Cloud
        run: |
          docker pull ${{ env.STOREFRONT_REPO }}:${{ env.STOREFRONT_TAG }}
          docker tag ${{ env.STOREFRONT_REPO }}:${{ env.STOREFRONT_TAG }} ${{ env.IMAGE_REPOSITORY }}:${{ env.STOREFRONT_TAG }}
          docker push ${{ env.IMAGE_REPOSITORY }}:${{ env.STOREFRONT_TAG }}

      - name: Update app
        # Using Krasnodar scoped token, no need to specify organization
        run: |
          vc-build SetEnvParameter -CloudUrl https://portal.virtocloud.dev -CloudToken ${{ secrets.KRASNODAR_PORTAL_TOKEN }} -EnvironmentName ${{ env.APP_NAME }} -HelmParameters storefront.image.tag=$TAG
        env:
          TAG: ${{ env.STOREFRONT_TAG }}
